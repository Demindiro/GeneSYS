x86-64 / x64 / AMD64 / IA32e
============================

Two types of kernels are provided:

- UEFI / BIOS compatible
- Unikernel (**TODO**)

The UEFI / BIOS kernel is intended for use on real hardware.

The unikernel is designed for "cloud" VPSes: small virtual machines
typically dedicated to a single application.

Only the UEFI/BIOS compatible kernels provide security and debugging tools.
The unikernel is designed to minimize overhead and to utilize debugging tools
provided by the hypervisor.

At least 10MiB of physical memory is required to be usable at all.
(first 2MiB reserved, 4MiB for the kernel and 4MiB for initial OS)


Supported hardware
------------------

- Memory
- MMU
- UART (COM1/COM2)
- PCI / PCIe (**TODO**)
- VirtIO (unikernel)
  - block (**TODO**)
  - net (**TODO**)


Initial OS
----------

The kernel can optionally load an OS at boot,
avoiding the need to start an OS through the serial link.

An address space is created with the following ranges defined:

- `0x3f000000` until `0x3f400000`: kernel code / data (RX[W])
- `0x3f800000` until `0x40000000`: page table (R)
- `0x3fe00000` until `0x40000000`: OS code (RX)

Note an OS starts with no data pages.
An OS should map in their own data pages.

The initial OS code is limited to at most 2MiB.
Extra code should be loaded externally.

The page table provides read-only access to the paging structure
currently in use. Updates can only be done through system calls.


System calls
------------

To efficiently support unikernels,
direct usage of the `syscall` instruction is prohibited.
Instead, all calls are proxied through routines mapped at
a fixed location.

System calls may use SSE registers.
To avoid leaking data or needing to save registers,
`vzeroall` (or equivalent) is always called before returning.


(Physical) memory allocation
----------------------------

By default, memory is divided in pages of 2MiB.
All memory allocations use whole 2MiB pages.
This makes it more convenient to use 2M pages in many places,
improving TLB performance.

It is likely many 4KiB pages are inaccessible by default with this scheme,
but this is not expected to be a significant issue.

Each page has a 32-bit reference count, which is used for:

- sharing pages between OSes (and the kernel!)
- indicating whether a page is free or in use.

Pages are always recorded in the page table (even if unused/"not present").
A 4K page reference increases the reference count of its containing 2M page.

To avoid needing to scan a potentially very large array (see table below)
pages are grouped in sets of 128 entries, each set having a 8-bit counter
indicating the number of free pages.

Additionaly, there are supersets of 256 entries each, each superset having
a 16-bit counter indicating the number of free pages.

At most 256K pages can be referenced.
This is because the 1MiB-2MiB region is used for keeping track of reference counts.

| total physical memory | pages | sets | supersets |
| ---------------------:| -----:| ----:| ---------:|
|                   16M |     8 |    1 |         1 |
|                   32M |    16 |    1 |         1 |
|                   64M |    32 |    1 |         1 |
|                  128M |    64 |    1 |         1 |
|                  256M |   128 |    1 |         1 |
|                  512M |   256 |    2 |         1 |
|                    1G |   512 |    4 |         1 |
|                    2G |    1K |    8 |         1 |
|                    4G |    2K |   16 |         1 |
|                    8G |    4K |   32 |         1 |
|                   16G |    8K |   64 |         1 |
|                   32G |   16K |  128 |         1 |
|                   64G |   32K |  256 |         1 |
|                  128G |   64K |  512 |         2 |
|                  256G |  128K |   1K |         4 |
|                  512G |  256K |   2K |         8 |

### 1G pages

On systems with an extreme amount of physical memory it may make more sense
to use 1G pages as base size instead of 2M.

| total physical memory | pages | sets | supersets |
| ---------------------:| -----:| ----:| ---------:|
|                    1G |     1 |    1 |         1 |
|                    2G |     2 |    1 |         1 |
|                    4G |     4 |    1 |         1 |
|                    8G |     8 |    1 |         1 |
|                   16G |    16 |    1 |         1 |
|                   32G |    32 |    1 |         1 |
|                   64G |    64 |    1 |         1 |
|                  128G |   128 |    1 |         1 |
|                  256G |   256 |    2 |         1 |
|                  512G |   512 |    4 |         1 |
|                    1T |    1K |    8 |         1 |
|                    2T |    2K |   16 |         1 |
|                    4T |    4K |   32 |         1 |
|                    8T |    8K |   64 |         1 |
|                   16T |   16K |  128 |         1 |
|                   32T |   32K |  256 |         1 |
|                   64T |   64K |  512 |         2 |
|                  128T |  128K |   1K |         4 |
|                  256T |  256K |   2K |         8 |

